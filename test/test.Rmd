---
title: "test"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Set root directory of all chunks to current working directory.
# !!! NOTE: Change this to your directory if needed.
knitr::opts_knit$set(root.dir = getwd())

library(igraph)
library(ggplot2)
library(reshape2)
library(dplyr)
library(tidyr)
# library(logger)
# library(parallel)
# library(readr)
library(rlang)
library(tictoc)
library(data.table)
library(netrb)
library(Matrix)
library(pbapply)

# Read example graphs from file.
graphs <- list(
  pg = read_graph('networks/power_grid.txt',
                  format   = 'edgelist',
                  directed = FALSE),
  ir = read_graph('networks/internet_routers.txt',
                  format   = 'edgelist',
                  directed = FALSE),
  cr = read_graph('networks/roads_ca.txt',
                  format   = 'edgelist',
                  directed = FALSE)
)
# Pre-calculate diameters of graphs, via igraph, Gephi, etc,
# since initializing a station_graph requires this,
# and it is computationally expensive
diams <- list(pg = 46,
              ir = 11,
              cr = 849)
```

```{r}
# TODO delete and try w/ actual package.
# Import all `.R` files from the `R/` directory.
r_source_dir  <- sprintf('%s/R', dirname(getwd()))
r_source_file_paths <- list.files(r_source_dir, full.names = TRUE)
# Run `source()` on each source file path to import.
invisible(sapply(r_source_file_paths, source))
set.seed(0)
# g <- sample_pa(1e5)

sim <- simulator(g        = graphs$ir,
                 .name    = 'test_ir',
                 diam     = diams$ir,
                 name_is_new = FALSE)
```

```{r}
tic()
s0 <- vao(sim, '')
toc()
```

```{r}
delete_simulator(sim)
```

```{r}
tic()
set.seed(-1)
g <- graphs$cr
s1 <- sample(vcount(g), 2e2)
# set.seed(-2)
s2 <- sample(vcount(g), 2e2)
d <- distances(g, v=s1, to=s2)
toc()
# rownames(d) <- s1
# colnames(d) <- s2
fwrite(d, "dists.csv")

```

```{r}
tic()
x <- centr_betw(graphs$ir)$res
toc()
```

```{r}

tic()
set.seed(1)
tt <- sample(5e6)
trow <- as.list(tt)
tcol <- matrix(tt, ncol = 1)
fwrite(trow, "row.csv", col.names = FALSE)
fwrite(tcol, "col.csv", col.names = FALSE)
toc()
```
```{r}
tic()
# rr <- as.matrix(fread("col.csv"))
d2 <- fread("dists.csv")
toc()
```

```{r}
tic()
rc <- fread("row.csv")
toc()
```


```{r}
# TODO replace ALL `rs` with `sim`.
res <- func_vs_deletions(
  sim,
  integrity,
  attrs = c('rand', 'eign'),
  del_max = 0.5,
  vcount_orig = vcount(graphs$cr),
  nchunks = 10
)
res
```





```{r}
plot_func_vs_deletions(res, 'a')
```

